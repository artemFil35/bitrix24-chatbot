import logging
from typing import Optional, List, Dict
from app import db
from models import KnowledgeBaseArticle


class KnowledgeBaseManager:
    """ÐœÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð±Ð°Ð·Ð¾Ð¹ Ð·Ð½Ð°Ð½Ð¸Ð¹"""
    
    def __init__(self):
        self.categories = {
            'Ð¾Ñ‚Ð¿ÑƒÑÐº': ['Ð¾Ñ‚Ð¿ÑƒÑÐº', 'Ð¾Ñ‚Ð³ÑƒÐ»', 'Ð²Ñ‹Ñ…Ð¾Ð´Ð½Ð¾Ð¹', 'Ð¾Ñ‚Ð´Ñ‹Ñ…', 'vacation'],
            'Ð±Ð¾Ð»ÑŒÐ½Ð¸Ñ‡Ð½Ñ‹Ð¹': ['Ð±Ð¾Ð»ÑŒÐ½Ð¸Ñ‡Ð½Ñ‹Ð¹', 'Ð±Ð¾Ð»ÐµÐ·Ð½ÑŒ', 'Ð¼ÐµÐ´Ð¸Ñ†Ð¸Ð½Ð°', 'Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ', 'Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ'],
            'Ð·Ð°Ñ€Ð¿Ð»Ð°Ñ‚Ð°': ['Ð·Ð°Ñ€Ð¿Ð»Ð°Ñ‚Ð°', 'Ð¾Ð¿Ð»Ð°Ñ‚Ð°', 'Ð´ÐµÐ½ÑŒÐ³Ð¸', 'Ð¿Ñ€ÐµÐ¼Ð¸Ñ', 'Ð±Ð¾Ð½ÑƒÑ'],
            'Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹': ['Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚', 'ÑÐ¿Ñ€Ð°Ð²ÐºÐ°', 'Ð·Ð°ÑÐ²Ð»ÐµÐ½Ð¸Ðµ', 'Ð±ÑƒÐ¼Ð°Ð³Ð¸'],
            'Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ': ['Ð²Ñ€ÐµÐ¼Ñ', 'Ð³Ñ€Ð°Ñ„Ð¸Ðº', 'ÑÐ¼ÐµÐ½Ð°', 'Ð¾Ð¿Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ', 'Ð¿ÐµÑ€ÐµÑ€Ð°Ð±Ð¾Ñ‚ÐºÐ°'],
            'Ð»ÑŒÐ³Ð¾Ñ‚Ñ‹': ['Ð»ÑŒÐ³Ð¾Ñ‚Ð°', 'ÐºÐ¾Ð¼Ð¿ÐµÐ½ÑÐ°Ñ†Ð¸Ñ', 'Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð²Ñ‹Ð¿Ð»Ð°Ñ‚Ñ‹', 'ÑÐ¾Ñ†Ð¿Ð°ÐºÐµÑ‚'],
            'Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ðµ': ['Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ðµ', 'ÐºÑƒÑ€ÑÑ‹', 'Ñ‚Ñ€ÐµÐ½Ð¸Ð½Ð³', 'Ñ€Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ðµ', 'Ð½Ð°Ð²Ñ‹ÐºÐ¸'],
            'Ð¾Ð±Ð¾Ñ€ÑƒÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ': ['ÐºÐ¾Ð¼Ð¿ÑŒÑŽÑ‚ÐµÑ€', 'Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ°', 'Ð¾Ð±Ð¾Ñ€ÑƒÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ', 'Ð½Ð¾ÑƒÑ‚Ð±ÑƒÐº', 'Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½'],
            'Ð¾Ñ„Ð¸Ñ': ['Ð¾Ñ„Ð¸Ñ', 'Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐµ Ð¼ÐµÑÑ‚Ð¾', 'Ð¿Ð°Ñ€ÐºÐ¾Ð²ÐºÐ°', 'ÑÑ‚Ð¾Ð»Ð¾Ð²Ð°Ñ', 'ÐºÑƒÑ…Ð½Ñ'],
            'ÐºÐ¾Ð»Ð»ÐµÐ³Ð¸': ['ÐºÐ¾Ð»Ð»ÐµÐ³Ð¸', 'ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°', 'ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¸', 'Ñ€ÑƒÐºÐ¾Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒ', 'Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¸Ðº']
        }
    
    def search_knowledge_base(self, query: str) -> Optional[str]:
        """ÐŸÐ¾Ð¸ÑÐº Ð² Ð±Ð°Ð·Ðµ Ð·Ð½Ð°Ð½Ð¸Ð¹ Ð¿Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÑƒ"""
        try:
            query_lower = query.lower()
            
            # Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¸Ñ‰ÐµÐ¼ Ñ‚Ð¾Ñ‡Ð½Ñ‹Ðµ ÑÐ¾Ð²Ð¿Ð°Ð´ÐµÐ½Ð¸Ñ Ð² Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ°Ñ…
            exact_match = KnowledgeBaseArticle.query.filter(
                KnowledgeBaseArticle.is_active == True,
                KnowledgeBaseArticle.title.ilike(f'%{query}%')
            ).first()
            
            if exact_match:
                exact_match.usage_count += 1
                db.session.commit()
                return self._format_article_response(exact_match)
            
            # Ð˜Ñ‰ÐµÐ¼ Ð¿Ð¾ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ð¼ ÑÐ»Ð¾Ð²Ð°Ð¼ Ð² ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑÑ…
            relevant_category = self._find_relevant_category(query_lower)
            if relevant_category:
                articles = KnowledgeBaseArticle.query.filter(
                    KnowledgeBaseArticle.is_active == True,
                    KnowledgeBaseArticle.category == relevant_category
                ).order_by(KnowledgeBaseArticle.usage_count.desc()).limit(3).all()
                
                if articles:
                    # Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ ÑÐ°Ð¼ÑƒÑŽ Ð¿Ð¾Ð¿ÑƒÐ»ÑÑ€Ð½ÑƒÑŽ ÑÑ‚Ð°Ñ‚ÑŒÑŽ Ð¸Ð· ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸
                    best_article = articles[0]
                    best_article.usage_count += 1
                    db.session.commit()
                    return self._format_article_response(best_article)
            
            # Ð˜Ñ‰ÐµÐ¼ Ð¿Ð¾ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ð¼Ñƒ ÑÑ‚Ð°Ñ‚ÐµÐ¹
            content_match = KnowledgeBaseArticle.query.filter(
                KnowledgeBaseArticle.is_active == True,
                KnowledgeBaseArticle.content.ilike(f'%{query}%')
            ).order_by(KnowledgeBaseArticle.usage_count.desc()).first()
            
            if content_match:
                content_match.usage_count += 1
                db.session.commit()
                return self._format_article_response(content_match)
            
            # Ð˜Ñ‰ÐµÐ¼ Ð¿Ð¾ Ñ‚ÐµÐ³Ð°Ð¼
            tag_match = KnowledgeBaseArticle.query.filter(
                KnowledgeBaseArticle.is_active == True,
                KnowledgeBaseArticle.tags.ilike(f'%{query}%')
            ).order_by(KnowledgeBaseArticle.usage_count.desc()).first()
            
            if tag_match:
                tag_match.usage_count += 1
                db.session.commit()
                return self._format_article_response(tag_match)
            
            return None
            
        except Exception as e:
            logging.error(f"Error searching knowledge base: {str(e)}")
            return None
    
    def _find_relevant_category(self, query: str) -> Optional[str]:
        """ÐŸÐ¾Ð¸ÑÐº Ñ€ÐµÐ»ÐµÐ²Ð°Ð½Ñ‚Ð½Ð¾Ð¹ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ Ð¿Ð¾ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ð¼ ÑÐ»Ð¾Ð²Ð°Ð¼"""
        for category, keywords in self.categories.items():
            for keyword in keywords:
                if keyword in query:
                    return category
        return None
    
    def _format_article_response(self, article: KnowledgeBaseArticle) -> str:
        """Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð¸Ð· ÑÑ‚Ð°Ñ‚ÑŒÐ¸ Ð±Ð°Ð·Ñ‹ Ð·Ð½Ð°Ð½Ð¸Ð¹"""
        response = f"ðŸ“‹ **{article.title}**\n\n"
        response += article.content
        
        if article.get_tags_list():
            response += f"\n\nðŸ·ï¸ Ð¢ÐµÐ³Ð¸: {', '.join(article.get_tags_list())}"
        
        response += "\n\nðŸ’¡ Ð•ÑÐ»Ð¸ Ñƒ Ð²Ð°Ñ Ð¾ÑÑ‚Ð°Ð»Ð¸ÑÑŒ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹, Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº HR-ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸ÑÑ‚Ñƒ."
        
        return response
    
    def get_popular_articles(self, limit: int = 5) -> List[KnowledgeBaseArticle]:
        """ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð¿ÑƒÐ»ÑÑ€Ð½Ñ‹Ñ… ÑÑ‚Ð°Ñ‚ÐµÐ¹"""
        try:
            return KnowledgeBaseArticle.query.filter_by(
                is_active=True
            ).order_by(
                KnowledgeBaseArticle.usage_count.desc()
            ).limit(limit).all()
            
        except Exception as e:
            logging.error(f"Error getting popular articles: {str(e)}")
            return []
    
    def get_articles_by_category(self, category: str) -> List[KnowledgeBaseArticle]:
        """ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚ÐµÐ¹ Ð¿Ð¾ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸"""
        try:
            return KnowledgeBaseArticle.query.filter(
                KnowledgeBaseArticle.is_active == True,
                KnowledgeBaseArticle.category == category
            ).order_by(
                KnowledgeBaseArticle.usage_count.desc()
            ).all()
            
        except Exception as e:
            logging.error(f"Error getting articles by category: {str(e)}")
            return []
    
    def create_default_articles(self):
        """Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÑ‚Ð°Ñ‚ÐµÐ¹ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ"""
        try:
            default_articles = [
                {
                    'title': 'ÐšÐ°Ðº Ð¾Ñ„Ð¾Ñ€Ð¼Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð¿ÑƒÑÐº',
                    'content': '''Ð”Ð»Ñ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾Ñ‚Ð¿ÑƒÑÐºÐ° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾:

1. ÐŸÐ¾Ð´Ð°Ñ‚ÑŒ Ð·Ð°ÑÐ²Ð»ÐµÐ½Ð¸Ðµ Ð½Ð° Ð¾Ñ‚Ð¿ÑƒÑÐº Ð½Ðµ Ð¼ÐµÐ½ÐµÐµ Ñ‡ÐµÐ¼ Ð·Ð° 2 Ð½ÐµÐ´ÐµÐ»Ð¸ Ð´Ð¾ Ð¿Ð»Ð°Ð½Ð¸Ñ€ÑƒÐµÐ¼Ð¾Ð¹ Ð´Ð°Ñ‚Ñ‹
2. Ð¡Ð¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ñ‚ÑŒ Ð´Ð°Ñ‚Ñ‹ Ñ Ð½ÐµÐ¿Ð¾ÑÑ€ÐµÐ´ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¼ Ñ€ÑƒÐºÐ¾Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÐµÐ¼
3. ÐŸÐµÑ€ÐµÐ´Ð°Ñ‚ÑŒ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ Ð´ÐµÐ»Ð° ÐºÐ¾Ð»Ð»ÐµÐ³Ð°Ð¼ Ð¸Ð»Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð·Ð°Ð¼ÐµÑ‰Ð°ÑŽÑ‰ÐµÐ¼Ñƒ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÑƒ
4. Ð£Ð²ÐµÐ´Ð¾Ð¼Ð¸Ñ‚ÑŒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð² Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¼ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ð¸ (ÐµÑÐ»Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ð¸Ð¼Ð¾)

ðŸ“ Ð—Ð°ÑÐ²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð´Ð°ÐµÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· ÐºÐ¾Ñ€Ð¿Ð¾Ñ€Ð°Ñ‚Ð¸Ð²Ð½ÑƒÑŽ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ Ð¸Ð»Ð¸ Ð² ÐºÐ°Ð´Ñ€Ð¾Ð²ÑƒÑŽ ÑÐ»ÑƒÐ¶Ð±Ñƒ.
â° ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð¾Ñ‚Ð¿ÑƒÑÐºÐ° - 3 Ð´Ð½Ñ.
ðŸ“… Ð•Ð¶ÐµÐ³Ð¾Ð´Ð½Ñ‹Ð¹ Ð¾Ð¿Ð»Ð°Ñ‡Ð¸Ð²Ð°ÐµÐ¼Ñ‹Ð¹ Ð¾Ñ‚Ð¿ÑƒÑÐº ÑÐ¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ 28 ÐºÐ°Ð»ÐµÐ½Ð´Ð°Ñ€Ð½Ñ‹Ñ… Ð´Ð½ÐµÐ¹.''',
                    'category': 'Ð¾Ñ‚Ð¿ÑƒÑÐº',
                    'tags': 'Ð¾Ñ‚Ð¿ÑƒÑÐº, Ð·Ð°ÑÐ²Ð»ÐµÐ½Ð¸Ðµ, Ð¾Ñ‚Ð´Ñ‹Ñ…, ÐºÐ°Ð»ÐµÐ½Ð´Ð°Ñ€ÑŒ'
                },
                {
                    'title': 'ÐŸÑ€Ð¾Ñ†ÐµÐ´ÑƒÑ€Ð° Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ñ Ð±Ð¾Ð»ÑŒÐ½Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ Ð»Ð¸ÑÑ‚Ð°',
                    'content': '''ÐŸÑ€Ð¸ Ð±Ð¾Ð»ÐµÐ·Ð½Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾:

1. Ð’ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð±Ð¾Ð»ÐµÐ·Ð½Ð¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð¸Ñ‚ÑŒ Ð½ÐµÐ¿Ð¾ÑÑ€ÐµÐ´ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ€ÑƒÐºÐ¾Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»Ñ Ð´Ð¾ 10:00
2. ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÑŒÑÑ Ðº Ð²Ñ€Ð°Ñ‡Ñƒ Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒÐ½Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð»Ð¸ÑÑ‚
3. Ð’ Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ 3 Ð´Ð½ÐµÐ¹ Ð¿Ð¾ÑÐ»Ðµ Ð²Ñ‹Ð·Ð´Ð¾Ñ€Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒÐ½Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð»Ð¸ÑÑ‚ Ð² ÐºÐ°Ð´Ñ€Ð¾Ð²ÑƒÑŽ ÑÐ»ÑƒÐ¶Ð±Ñƒ
4. Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹ Ð½ÐµÑ‚Ñ€ÑƒÐ´Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚Ð¸

ðŸ’Š Ð‘Ð¾Ð»ÑŒÐ½Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð¾Ð¿Ð»Ð°Ñ‡Ð¸Ð²Ð°ÐµÑ‚ÑÑ ÑÐ¾Ð³Ð»Ð°ÑÐ½Ð¾ Ñ‚Ñ€ÑƒÐ´Ð¾Ð²Ð¾Ð¼Ñƒ Ð·Ð°ÐºÐ¾Ð½Ð¾Ð´Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ñƒ.
ðŸ“‹ Ð­Ð»ÐµÐºÑ‚Ñ€Ð¾Ð½Ð½Ñ‹Ðµ Ð±Ð¾Ð»ÑŒÐ½Ð¸Ñ‡Ð½Ñ‹Ðµ Ð»Ð¸ÑÑ‚Ñ‹ Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÑŽÑ‚ÑÑ Ð½Ð°Ñ€Ð°Ð²Ð½Ðµ Ñ Ð±ÑƒÐ¼Ð°Ð¶Ð½Ñ‹Ð¼Ð¸.
âš•ï¸ ÐŸÑ€Ð¸ Ð±Ð¾Ð»ÐµÐ·Ð½Ð¸ Ð±Ð¾Ð»ÐµÐµ 3 Ð´Ð½ÐµÐ¹ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¼ÐµÐ´Ð¸Ñ†Ð¸Ð½ÑÐºÐ¾Ð¹ ÑÐ¿Ñ€Ð°Ð²ÐºÐ¸.''',
                    'category': 'Ð±Ð¾Ð»ÑŒÐ½Ð¸Ñ‡Ð½Ñ‹Ð¹',
                    'tags': 'Ð±Ð¾Ð»ÑŒÐ½Ð¸Ñ‡Ð½Ñ‹Ð¹, Ð±Ð¾Ð»ÐµÐ·Ð½ÑŒ, Ð¼ÐµÐ´Ð¸Ñ†Ð¸Ð½Ð°, ÑÐ¿Ñ€Ð°Ð²ÐºÐ°'
                },
                {
                    'title': 'Ð“Ñ€Ð°Ñ„Ð¸Ðº Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐ³Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸',
                    'content': '''Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ð¹ Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ð¹ Ð³Ñ€Ð°Ñ„Ð¸Ðº:

ðŸ•˜ ÐÐ°Ñ‡Ð°Ð»Ð¾ Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐ³Ð¾ Ð´Ð½Ñ: 9:00
ðŸ•” ÐžÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐ³Ð¾ Ð´Ð½Ñ: 18:00
ðŸ• ÐžÐ±ÐµÐ´ÐµÐ½Ð½Ñ‹Ð¹ Ð¿ÐµÑ€ÐµÑ€Ñ‹Ð²: 13:00-14:00
ðŸ“… Ð Ð°Ð±Ð¾Ñ‡Ð¸Ðµ Ð´Ð½Ð¸: Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº-Ð¿ÑÑ‚Ð½Ð¸Ñ†Ð°

Ð“Ð¸Ð±ÐºÐ¸Ð¹ Ð³Ñ€Ð°Ñ„Ð¸Ðº:
- Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð½Ð°Ñ‡Ð¸Ð½Ð°Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ 8:00 Ð´Ð¾ 10:00
- Ð¡Ð¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ ÑÐ´Ð²Ð¸Ð³ Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐ³Ð¾ Ð´Ð½Ñ
- ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð² Ð¾Ñ„Ð¸ÑÐµ Ñ 10:00 Ð´Ð¾ 16:00

ðŸ“ Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² Ð³Ñ€Ð°Ñ„Ð¸ÐºÐµ ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ñ‹Ð²Ð°ÑŽÑ‚ÑÑ Ñ Ñ€ÑƒÐºÐ¾Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÐµÐ¼.
ðŸ  Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ð¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¾Ð±ÑÑƒÐ¶Ð´Ð°ÐµÑ‚ÑÑ Ð¸Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ð¾.''',
                    'category': 'Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ',
                    'tags': 'Ð³Ñ€Ð°Ñ„Ð¸Ðº, Ð²Ñ€ÐµÐ¼Ñ, Ñ€Ð°Ð±Ð¾Ñ‚Ð°, Ð¾Ñ„Ð¸Ñ, Ð³Ð¸Ð±ÐºÐ¸Ð¹ Ð³Ñ€Ð°Ñ„Ð¸Ðº'
                },
                {
                    'title': 'ÐšÐ¾Ñ€Ð¿Ð¾Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð»ÑŒÐ³Ð¾Ñ‚Ñ‹ Ð¸ ÐºÐ¾Ð¼Ð¿ÐµÐ½ÑÐ°Ñ†Ð¸Ð¸',
                    'content': '''Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð»ÑŒÐ³Ð¾Ñ‚Ñ‹:

ðŸ’¼ Ð”ÐœÐ¡ (Ð´Ð¾Ð±Ñ€Ð¾Ð²Ð¾Ð»ÑŒÐ½Ð¾Ðµ Ð¼ÐµÐ´Ð¸Ñ†Ð¸Ð½ÑÐºÐ¾Ðµ ÑÑ‚Ñ€Ð°Ñ…Ð¾Ð²Ð°Ð½Ð¸Ðµ)
ðŸš— ÐšÐ¾Ð¼Ð¿ÐµÐ½ÑÐ°Ñ†Ð¸Ñ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð½Ñ‹Ñ… Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð²
ðŸ½ï¸ Ð¡ÑƒÐ±ÑÐ¸Ð´Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ðµ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸Ðµ Ð² ÐºÐ¾Ñ€Ð¿Ð¾Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ð¾Ð¹ ÑÑ‚Ð¾Ð»Ð¾Ð²Ð¾Ð¹
ðŸ“š ÐšÐ¾Ð¼Ð¿ÐµÐ½ÑÐ°Ñ†Ð¸Ñ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¸ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ñ… ÐºÑƒÑ€ÑÐ¾Ð²
ðŸ‹ï¸ ÐšÐ¾Ñ€Ð¿Ð¾Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ñ„Ð¸Ñ‚Ð½ÐµÑ
ðŸŽ¯ ÐŸÑ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð° Ð»Ð¾ÑÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ñ Ð±Ð¾Ð½ÑƒÑÐ°Ð¼Ð¸

Ð£ÑÐ»Ð¾Ð²Ð¸Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ:
- Ð˜ÑÐ¿Ñ‹Ñ‚Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ ÑÑ€Ð¾Ðº Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½
- Ð¡Ñ‚Ð°Ð¶ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð² ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸ Ð¾Ñ‚ 3 Ð¼ÐµÑÑÑ†ÐµÐ²
- ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð´Ð¸ÑÑ†Ð¸Ð¿Ð»Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ñ… Ð²Ð·Ñ‹ÑÐºÐ°Ð½Ð¸Ð¹

ðŸ“‹ ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð¾ÑÑ‚Ð¸ ÑƒÑ‚Ð¾Ñ‡Ð½ÑÐ¹Ñ‚Ðµ Ð² ÐºÐ°Ð´Ñ€Ð¾Ð²Ð¾Ð¹ ÑÐ»ÑƒÐ¶Ð±Ðµ.''',
                    'category': 'Ð»ÑŒÐ³Ð¾Ñ‚Ñ‹',
                    'tags': 'Ð»ÑŒÐ³Ð¾Ñ‚Ñ‹, ÐºÐ¾Ð¼Ð¿ÐµÐ½ÑÐ°Ñ†Ð¸Ð¸, Ð”ÐœÐ¡, Ñ„Ð¸Ñ‚Ð½ÐµÑ, Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ðµ'
                },
                {
                    'title': 'Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ð¸ IT-Ð¾Ð±Ð¾Ñ€ÑƒÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ',
                    'content': '''Ð”Ð»Ñ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð²:

ðŸ’» Ð—Ð°ÑÐ²ÐºÐ¸ Ð½Ð° IT-Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ Ð¿Ð¾Ð´Ð°ÑŽÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· ÐºÐ¾Ñ€Ð¿Ð¾Ñ€Ð°Ñ‚Ð¸Ð²Ð½ÑƒÑŽ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ
ðŸ“ž Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ ÑÐ»ÑƒÐ¶Ð±Ñ‹ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸: Ð´Ð¾Ð±. 100
ðŸ”§ Ð’Ñ€ÐµÐ¼Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸: 9:00-18:00 Ð² Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ðµ Ð´Ð½Ð¸

Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð¾Ðµ Ð¾Ð±Ð¾Ñ€ÑƒÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ:
- Ð Ð°Ð±Ð¾Ñ‡Ð¸Ð¹ ÐºÐ¾Ð¼Ð¿ÑŒÑŽÑ‚ÐµÑ€ Ð¸Ð»Ð¸ Ð½Ð¾ÑƒÑ‚Ð±ÑƒÐº
- ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€ (Ð¿Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÑƒ Ð²Ñ‚Ð¾Ñ€Ð¾Ð¹)
- ÐšÐ»Ð°Ð²Ð¸Ð°Ñ‚ÑƒÑ€Ð° Ð¸ Ð¼Ñ‹ÑˆÑŒ
- ÐšÐ¾Ñ€Ð¿Ð¾Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½ (Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸)

âš ï¸ Ð›Ð¸Ñ‡Ð½Ð¾Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ñ€Ð¿Ð¾Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ð¾Ð³Ð¾ Ð¾Ð±Ð¾Ñ€ÑƒÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¾.
ðŸ”’ ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑÐ¾Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ð¹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸.''',
                    'category': 'Ð¾Ð±Ð¾Ñ€ÑƒÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ',
                    'tags': 'IT, ÐºÐ¾Ð¼Ð¿ÑŒÑŽÑ‚ÐµÑ€, Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ°, Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°, Ð¾Ð±Ð¾Ñ€ÑƒÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ'
                }
            ]
            
            for article_data in default_articles:
                existing = KnowledgeBaseArticle.query.filter_by(
                    title=article_data['title']
                ).first()
                
                if not existing:
                    article = KnowledgeBaseArticle(**article_data)
                    db.session.add(article)
            
            db.session.commit()
            logging.info("Default knowledge base articles created")
            
        except Exception as e:
            logging.error(f"Error creating default articles: {str(e)}")
            db.session.rollback()
    
    def search_similar_questions(self, query: str, limit: int = 3) -> List[str]:
        """ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾Ñ…Ð¾Ð¶Ð¸Ñ… Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð´Ð»Ñ Ð¿Ð¾Ð´ÑÐºÐ°Ð·Ð¾Ðº"""
        try:
            # ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ð¿Ð¾Ð¸ÑÐº Ð¿Ð¾ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ð¼ ÑÐ»Ð¾Ð²Ð°Ð¼
            query_words = query.lower().split()
            similar_questions = []
            
            # ÐŸÑ€ÐµÐ´Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ñ‹Ðµ Ñ‡Ð°ÑÑ‚Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹
            common_questions = [
                "ÐšÐ°Ðº Ð¾Ñ„Ð¾Ñ€Ð¼Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð¿ÑƒÑÐº?",
                "Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¸ Ð±Ð¾Ð»ÐµÐ·Ð½Ð¸?",
                "ÐšÐ°ÐºÐ¾Ð¹ Ð³Ñ€Ð°Ñ„Ð¸Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹?",
                "ÐšÐ°ÐºÐ¸Ðµ ÐµÑÑ‚ÑŒ Ð»ÑŒÐ³Ð¾Ñ‚Ñ‹?",
                "ÐšÐ°Ðº Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ?",
                "Ð“Ð´Ðµ Ð½Ð°Ð¹Ñ‚Ð¸ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹?",
                "ÐšÐ°Ðº ÑÐ²ÑÐ·Ð°Ñ‚ÑŒÑÑ Ñ HR?",
                "ÐšÐ¾Ð³Ð´Ð° Ð²Ñ‹Ð¿Ð»Ð°Ñ‡Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð·Ð°Ñ€Ð¿Ð»Ð°Ñ‚Ð°?",
                "ÐšÐ°Ðº Ð¾Ñ„Ð¾Ñ€Ð¼Ð¸Ñ‚ÑŒ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¸Ñ€Ð¾Ð²ÐºÑƒ?",
                "Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¸ Ð¾Ð¿Ð¾Ð·Ð´Ð°Ð½Ð¸Ð¸?"
            ]
            
            for question in common_questions:
                question_words = question.lower().split()
                if any(word in question_words for word in query_words):
                    similar_questions.append(question)
                    if len(similar_questions) >= limit:
                        break
            
            return similar_questions
            
        except Exception as e:
            logging.error(f"Error searching similar questions: {str(e)}")
            return []
